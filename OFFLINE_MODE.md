# 🔄 نظام العمل بدون إنترنت (Offline Mode)

## ✨ المميزات

### 1. **العمل الكامل بدون إنترنت**

- ✅ إضافة عملاء جدد
- ✅ إضافة معدات جديدة
- ✅ إنشاء عقود إيجار
- ✅ إرجاع معدات
- ✅ عرض جميع البيانات المحفوظة محلياً

### 2. **المزامنة التلقائية**

- 🔄 مزامنة تلقائية عند العودة للإنترنت
- 🔄 مزامنة دورية كل 5 دقائق
- 🔄 إعادة محاولة تلقائية للعمليات الفاشلة (حتى 3 محاولات)
- 🔄 ترتيب ذكي للعمليات (إضافة → تحديث → حذف)

### 3. **مؤشرات بصرية**

- 🟢 مؤشر الاتصال (متصل/غير متصل)
- 📊 عدد العمليات في الانتظار
- ⏰ وقت آخر مزامنة
- 🔄 زر المزامنة اليدوية

## 🛠️ كيفية العمل

### تخزين محلي (IndexedDB)

يتم حفظ جميع البيانات محلياً في متصفح المستخدم باستخدام IndexedDB:

```typescript
// الجداول المحلية
-customers - // العملاء
  equipment - // المعدات
  rentals - // الإيجارات
  rental_items - // عناصر الإيجار
  sync_queue; // قائمة انتظار العمليات
```

### قائمة انتظار العمليات (Sync Queue)

عند العمل بدون إنترنت، يتم إضافة كل عملية إلى قائمة الانتظار:

```typescript
{
  id: "uuid",
  table: "customers",
  operation: "insert",
  data: { /* بيانات العملية */ },
  timestamp: 1234567890,
  retries: 0
}
```

### عملية المزامنة

#### 1. **عند العودة للإنترنت:**

- ⏱️ انتظار 2 ثانية للتأكد من استقرار الاتصال
- 📤 معالجة جميع العمليات في قائمة الانتظار
- ✅ حذف العمليات الناجحة من القائمة
- ❌ إعادة محاولة العمليات الفاشلة
- 📥 سحب أحدث البيانات من السيرفر

#### 2. **مزامنة دورية:**

- كل 5 دقائق، يتم التحقق من وجود عمليات في الانتظار
- إذا كان هناك عمليات، يتم مزامنتها تلقائياً

#### 3. **مزامنة يدوية:**

- يمكن للمستخدم الضغط على زر "مزامنة الآن"
- مفيد عند الحاجة لمزامنة فورية

## 📝 استخدام النظام

### للمطورين

#### استخدام الـ Hooks الجاهزة:

```typescript
import {
  useOfflineQuery,
  useOfflineMutation,
} from "@/lib/offline/useOfflineData";

// قراءة البيانات
const { data: customers } = useOfflineQuery({
  queryKey: ["customers"],
  table: "customers",
  orderBy: { column: "created_at", ascending: false },
});

// كتابة البيانات
const createCustomer = useOfflineMutation({
  table: "customers",
  operation: "insert",
  onSuccess: () => {
    toast.success("تم إضافة العميل");
  },
});

// استخدام
createCustomer.mutate({
  full_name: "محمد",
  phone: "0501234567",
  // ...
});
```

### للمستخدمين

#### 1. **العمل بدون إنترنت:**

- استخدم التطبيق بشكل طبيعي
- سترى رسالة "تم حفظ العملية محلياً" عند إضافة أو تعديل البيانات
- جميع البيانات ستكون متاحة للعرض والتعديل

#### 2. **العودة للإنترنت:**

- ستظهر رسالة تلقائية "جاري المزامنة..."
- بعد انتهاء المزامنة، ستظهر رسالة "تم مزامنة X عملية بنجاح"
- جميع بياناتك الآن محفوظة في السيرفر

#### 3. **المزامنة اليدوية:**

- انظر للمربع في أسفل يسار الشاشة
- إذا كان هناك عمليات في الانتظار، اضغط "مزامنة الآن"

## 🔧 التهيئة

### متطلبات المتصفح

- IndexedDB support (جميع المتصفحات الحديثة)
- Service Worker support (اختياري للتخزين المؤقت)

### إعدادات إضافية (اختيارية)

#### تخصيص مدة المزامنة:

```typescript
// في SyncManager.tsx
const syncInterval = 5 * 60 * 1000; // 5 دقائق (افتراضي)
// يمكن تغييرها حسب الحاجة
```

#### تخصيص عدد المحاولات:

```typescript
// في sync.ts
const MAX_RETRIES = 3; // 3 محاولات (افتراضي)
```

## 🐛 معالجة الأخطاء

### العمليات الفاشلة

- يتم إعادة المحاولة تلقائياً 3 مرات
- بعد 3 محاولات فاشلة، يتم حذف العملية من القائمة
- يظهر إشعار للمستخدم

### تعارضات البيانات

- يتم استخدام timestamp لحل التعارضات
- البيانات الأحدث دائماً هي التي تُحفظ
- في حالة التعارض، يتم إعطاء الأولوية لبيانات السيرفر

## 📊 المراقبة

### Console Logs

جميع عمليات المزامنة مسجلة في الـ console:

```
Starting sync of 5 items
Successfully synced 5 items, pulling latest data...
Sync complete
```

### مؤشر الحالة

المربع في أسفل يسار الشاشة يعرض:

- 🟢 حالة الاتصال
- 📊 عدد العمليات في الانتظار
- ⏰ وقت آخر مزامنة

## 🚀 أفضل الممارسات

1. **تأكد من المزامنة الدورية**

   - اترك التطبيق مفتوحاً لمدة كافية لإتمام المزامنة

2. **استخدم المزامنة اليدوية**

   - عند إنهاء جلسة العمل، تأكد من مزامنة جميع البيانات

3. **لا تغلق المتصفح مباشرة**

   - انتظر حتى تكتمل المزامنة قبل إغلاق المتصفح

4. **راقب مؤشر الحالة**
   - تأكد من عدم وجود عمليات في الانتظار قبل الخروج

## 🔒 الأمان

- ✅ جميع البيانات المحلية مشفرة في المتصفح
- ✅ لا يتم مشاركة البيانات بين المستخدمين
- ✅ البيانات تُحذف عند تسجيل الخروج (اختياري)

## 📱 دعم الأجهزة

- ✅ Desktop (Windows, Mac, Linux)
- ✅ Mobile (iOS, Android)
- ✅ Tablet (iPad, Android Tablets)

## 🎯 الحالات المدعومة

### ✅ مدعوم

- العمل بدون إنترنت لفترات طويلة
- العودة للإنترنت والمزامنة
- قطع الاتصال المفاجئ
- اتصال ضعيف/متقطع

### ⚠️ محدود

- التعديل من أكثر من جهاز في نفس الوقت (قد تحدث تعارضات)
- العمليات الضخمة جداً (آلاف السجلات)

### ❌ غير مدعوم

- المزامنة عبر أجهزة متعددة بدون اتصال
- العمل الجماعي على نفس السجل بدون اتصال
